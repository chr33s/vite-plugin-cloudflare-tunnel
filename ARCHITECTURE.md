# Project Architecture: Cloudflare Tunnel Vite Plugin

## 1. Introduction

The `vite-plugin-cloudflare-tunnel` is a specialized Vite plugin designed to automate the process of exposing a local development server to the internet via a Cloudflare Tunnel. Its primary purpose is to simplify local development by providing public HTTPS access to a Vite-powered application without requiring manual tunnel setup, port forwarding, or complex certificate management.
    
This plugin streamlines the development workflow, allowing developers to quickly share their local work, test webhooks, or collaborate with others by making their development server accessible over a public URL, secured by Cloudflare's infrastructure.
                                                        
## 2. Project Structure

The repository has a clear and concise structure, typical for a standalone Vite plugin:

*   **`src/`**: This directory contains the core TypeScript source code for the Vite plugin.
    *   `index.ts`: The main entry point and implementation of the `cloudflareTunnel` plugin.
*   **`dist/`**: This directory is the build output target, where compiled JavaScript files (CommonJS and ES Modules) and TypeScript declaration files (`.d.ts`) are generated by `tsup`.
*   **`.claude/`**: Configuration for Claude AI interactions.
*   **`.cursor/`**: Configuration for Cursor editor rules.
*   **`.specstory/`**: Contains history and artifacts related to AI-assisted development sessions.
*   **`node_modules/`**: Contains all installed project dependencies.
*   **`package.json`**: Defines project metadata, scripts for development and building, and lists all dependencies (runtime, development, and peer).
*   **`tsconfig.json`**: Specifies TypeScript compiler options for the project.
*   **`tsup.config.ts`**: Configuration file for Tsup, the bundling tool used to build the plugin.
*   **`.gitignore`**: Specifies files and directories to be ignored by Git.
*   **`.cursorindexingignore`**: Specifies files and directories to be ignored by the Cursor AI indexing process.
                            
## 3. Key Components and Functionality

The `cloudflareTunnel` plugin, implemented primarily within `src/index.ts`, integrates directly with Vite's development server lifecycle. Its core components orchestrate interactions with the Cloudflare API and the `cloudflared` daemon.
                                                        
### 3.1. Main Plugin Entry (`cloudflareTunnel` function)

*   This is the default export of the plugin, callable from `vite.config.ts`.
*   It accepts an `Options` object, allowing developers to configure the Cloudflare API token, desired public hostname, and optional settings like local server port (auto-detected from Vite config if not specified), Cloudflare account/zone/tunnel names.
*   It returns a standard Vite `Plugin` object, implementing the necessary hooks (`configureServer` and `closeBundle`) to integrate with Vite's lifecycle.
                            
### 3.2. Cloudflare API Helper (`cf` utility)

*   A private asynchronous function (`cf`) serves as a robust wrapper for interacting with the Cloudflare REST API (version 4).
*   It handles:
    *   HTTP requests (GET, POST, PUT) to specific Cloudflare API endpoints.
    *   Authentication using the provided `Bearer` API token.
    *   JSON serialization for request bodies and deserialization for responses.
    *   **Response Validation**: Crucially, it leverages `zod` schemas (`CloudflareApiResponseSchema`, `AccountSchema`, `ZoneSchema`, `TunnelSchema`, `DNSRecordSchema`) to validate the structure and content of all Cloudflare API responses. This ensures type safety and helps catch unexpected API behaviors or malformed data early.
    *   Error handling for non-successful API responses.

### 3.3. `cloudflared` Binary Management

*   The plugin utilizes the `cloudflared` npm package to manage the `cloudflared` daemon, which is Cloudflare's command-line tool for running tunnels.
*   **Installation**: During the `configureServer` phase, it first checks if the `cloudflared` binary exists locally. If not, it automatically downloads and installs it using `cloudflared.install()`.
*   **Execution**: It spawns a child process (`node:child_process.spawn`) to run the `cloudflared tunnel run` command. This command is executed with `--no-autoupdate` and requires a specific tunnel token for authentication.
*   **Lifecycle Management**: The plugin monitors the `stdout` and `stderr` of the `cloudflared` process for connection status and errors. It also ensures that the `cloudflared` process is gracefully terminated when the Vite development server shuts down (via `SIGTERM`, falling back to `SIGKILL` if necessary).

### 3.4. Vite Plugin Hooks

*   **`configureServer(server)`**: This is the primary hook where the plugin's logic executes when the Vite development server starts.
    1.  **Dependency Check**: Ensures the `cloudflared` binary is available.
    2.  **Cloudflare Resource Resolution**: Dynamically determines the Cloudflare `accountId` and `zoneId` based on the provided `apiToken` and `hostname`.
    3.  **Tunnel Provisioning**: It queries for an existing tunnel matching the `tunnelName`. If not found, it creates a new Cloudflare Tunnel resource.
    4.  **Ingress Configuration**: It updates the tunnel's configuration to define ingress rules, mapping the public `hostname` to the local Vite development server's address (e.g., `http://localhost:5173`).
    5.  **DNS Management**: It checks for an existing CNAME DNS record for the `hostname` pointing to the tunnel's public endpoint (`<tunnelId>.cfargotunnel.com`). If absent, it creates this DNS record, enabling proxying through Cloudflare.
    6.  **Token Retrieval**: Fetches a unique, short-lived JWT token from the Cloudflare API, which is necessary for the `cloudflared` daemon to authenticate and connect to the tunnel.
    7.  **`cloudflared` Launch**: Starts the `cloudflared` child process using the retrieved token.
    8.  **Status Reporting**: Logs informative messages to the console, indicating when the tunnel has successfully started and is ready.
    9.  **Server Shutdown Hook**: Attaches a listener to the Vite server's `httpServer` "close" event to ensure the `cloudflared` process is terminated when the Vite server stops.
*   **`closeBundle()`**: This hook provides a secondary mechanism to terminate the `cloudflared` process, primarily useful in scenarios where the Vite build process completes or exits, ensuring no lingering `cloudflared` instances.
                                                        
## 4. Dependencies

The project leverages several external libraries to achieve its functionality:

### 4.1. Runtime Dependencies (`dependencies` in `package.json`)

*   **`cloudflared`**: The fundamental dependency that allows the plugin to programmatically interact with and manage the `cloudflared` executable.
*   **`dotenv`**: A zero-dependency module that loads environment variables from a `.env` file into `process.env`. While not explicitly called in the provided `src/index.ts`, it's typically used for local development configuration, especially for sensitive API keys.
*   **`zod`**: A powerful schema declaration and validation library. It is heavily used to ensure type safety and validate the structure of responses from the Cloudflare API, preventing runtime errors due to malformed data.
                                                        
### 4.2. Peer Dependencies (`peerDependencies` in `package.json`)

*   **`vite`**: The plugin's core functionality relies on Vite's architecture and lifecycle hooks. The `peerDependencies` entry ensures that the plugin is installed alongside a compatible version of Vite (versions 4.x or 5.x).
                                                        
### 4.3. Development Dependencies (`devDependencies` in `package.json`)

*   **`typescript`**: The primary language for the project, used for static type checking.
*   **`tsup`**: A fast, zero-config bundler for TypeScript libraries. It's used for compiling, bundling, and generating declaration files (`.d.ts`) for distribution.
*   **`eslint`**, **`@typescript-eslint/eslint-plugin`**, **`@typescript-eslint/parser`**: Tools for static code analysis and enforcing code style and best practices.
*   **`@types/node`**: Provides TypeScript type definitions for Node.js built-in modules (like `fs` and `child_process`).
                            
## 5. How Everything Fits Together

The `vite-plugin-cloudflare-tunnel` seamlessly integrates into the Vite development environment to provide an "always-on" public tunnel.
                            
1.  **Plugin Initialization**: When Vite starts its development server, it invokes the `cloudflareTunnel` function's `configureServer` hook.
2.  **API Communication & Resource Provisioning**: Inside `configureServer`, the plugin orchestrates a series of highly validated API calls to Cloudflare. It intelligently identifies the correct account and zone, then creates or reuses a Cloudflare Tunnel resource, and sets up the necessary ingress rules to point traffic from a chosen `hostname` to the local Vite server's `localhost:port`. Crucially, it also ensures the correct CNAME DNS record is in place for the `hostname`.
3.  **Secure Token Acquisition**: A temporary, secure token is fetched from Cloudflare, which acts as the credential for the `cloudflared` daemon.
4.  **Tunnel Daemon Launch**: The plugin then spawns the `cloudflared` executable as a child process on the local machine, passing it the acquired token. This `cloudflared` instance establishes a secure, persistent connection (the tunnel) from the developer's local machine to Cloudflare's global edge network.
5.  **Public Accessibility**: Once the `cloudflared` daemon reports a successful connection, the specified public `hostname` (e.g., `https://dev.example.com`) becomes immediately accessible from anywhere on the internet, with all traffic flowing securely through Cloudflare's infrastructure to the local development server.
6.  **Graceful Teardown**: Upon the Vite server's shutdown, the plugin's registered `close` event listener ensures that the `cloudflared` child process is cleanly terminated, releasing resources and preventing orphaned processes.
                                                        
This integrated approach provides a robust, secure, and automated solution for exposing local Vite development servers, significantly enhancing the developer experience for sharing and testing web applications.

---

**Relevant Files:**

*   `src/index.ts`
*   `package.json`
*   `tsconfig.json`
*   `tsup.config.ts` 